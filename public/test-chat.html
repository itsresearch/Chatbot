<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Chat Widget Test - Message Persistence</title>
        <style>
            body {
                margin: 0;
                padding: 20px;
                font-family:
                    system-ui,
                    -apple-system,
                    sans-serif;
                background: #f3f4f6;
            }
            .test-container {
                max-width: 1200px;
                margin: 0 auto;
            }
            .test-header {
                background: white;
                padding: 20px;
                border-radius: 8px;
                margin-bottom: 20px;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            }
            .test-header h1 {
                margin: 0 0 10px 0;
                color: #111827;
            }
            .test-header p {
                margin: 5px 0;
                color: #6b7280;
                font-size: 14px;
            }
            .test-section {
                background: white;
                padding: 20px;
                border-radius: 8px;
                margin-bottom: 20px;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            }
            .test-section h2 {
                margin: 0 0 15px 0;
                color: #111827;
                font-size: 18px;
                border-bottom: 2px solid #ff7a18;
                padding-bottom: 10px;
            }
            .test-item {
                margin: 15px 0;
                padding: 15px;
                background: #f9fafb;
                border-left: 4px solid #ff7a18;
                border-radius: 4px;
            }
            .test-controls {
                display: flex;
                gap: 10px;
                flex-wrap: wrap;
                margin: 15px 0;
            }
            button {
                padding: 10px 15px;
                background: #ff7a18;
                color: white;
                border: none;
                border-radius: 6px;
                cursor: pointer;
                font-size: 14px;
                font-weight: 600;
                transition: background 0.2s;
            }
            button:hover {
                background: #e8620b;
            }
            button.secondary {
                background: #6b7280;
            }
            button.secondary:hover {
                background: #4b5563;
            }
            .output {
                background: #1f2937;
                color: #10b981;
                padding: 15px;
                border-radius: 6px;
                font-family: "Courier New", monospace;
                font-size: 12px;
                max-height: 300px;
                overflow-y: auto;
                margin-top: 10px;
            }
            .output-line {
                margin: 3px 0;
            }
            .success {
                color: #10b981;
            }
            .error {
                color: #ef4444;
            }
            .info {
                color: #3b82f6;
            }
            .warning {
                color: #f59e0b;
            }
            .instructions {
                background: #eff6ff;
                border-left: 4px solid #3b82f6;
                padding: 15px;
                border-radius: 4px;
                margin-bottom: 15px;
                color: #1e40af;
                font-size: 14px;
                line-height: 1.6;
            }
            .widget-container {
                border: 2px dashed #ff7a18;
                padding: 20px;
                border-radius: 8px;
                background: #fffaf0;
                min-height: 100px;
                display: flex;
                align-items: center;
                justify-content: center;
                color: #cc5500;
                font-weight: 500;
            }
        </style>
    </head>
    <body>
        <div class="test-container">
            <div class="test-header">
                <h1>ðŸ§ª Chat Widget - Message Persistence Test Suite</h1>
                <p>
                    Testing localStorage persistence, message history restore,
                    and admin reply visibility
                </p>
                <p>
                    <strong>Status:</strong>
                    <span id="server-status" style="color: #ef4444"
                        >Checking connection...</span
                    >
                </p>
            </div>

            <!-- Test 1: Message Persistence -->
            <div class="test-section">
                <h2>Test 1: Message Persistence on Refresh</h2>
                <div class="instructions">
                    <strong>What we're testing:</strong> When you send a message
                    through the widget and then refresh the page, the message
                    should still be visible (stored in localStorage).<br />
                    <strong>How to test:</strong>
                    <ol style="margin: 10px 0">
                        <li>
                            Click "1. Open Widget Below" to display the chat
                            widget
                        </li>
                        <li>Type a test message and send it</li>
                        <li>Click "2. Refresh Page" button below</li>
                        <li>
                            Verify the message is still visible in the widget
                            after refresh
                        </li>
                        <li>
                            Click "Check localStorage" to verify data is stored
                        </li>
                    </ol>
                </div>
                <div class="test-controls">
                    <button id="open-widget-btn">1. Open Widget Below</button>
                    <button id="refresh-page-btn">2. Refresh Page</button>
                    <button class="secondary" id="check-storage-btn">
                        Check localStorage
                    </button>
                    <button class="secondary" id="clear-storage-btn">
                        Clear All Data
                    </button>
                </div>
                <div class="widget-container" id="widget-placeholder">
                    Chat widget will appear here â†’
                </div>
                <div class="output" id="storage-output"></div>
            </div>

            <!-- Test 2: Admin Dashboard Viewing -->
            <div class="test-section">
                <h2>Test 2: Admin Dashboard - Visitor Messages</h2>
                <div class="instructions">
                    <strong>What we're testing:</strong> Admin should see
                    visitor messages in the conversation dashboard.<br />
                    <strong>How to test:</strong>
                    <ol style="margin: 10px 0">
                        <li>Send a message from the widget (Test 1)</li>
                        <li>
                            Click "Open Admin Dashboard" to view conversation
                            list
                        </li>
                        <li>Verify your visitor messages appear in the list</li>
                    </ol>
                </div>
                <div class="test-controls">
                    <button id="open-admin-btn">Open Admin Dashboard</button>
                    <button class="secondary" id="fetch-conversations-btn">
                        Fetch Conversations
                    </button>
                </div>
                <div class="output" id="admin-output"></div>
            </div>

            <!-- Test 3: Admin Reply Visibility -->
            <div class="test-section">
                <h2>Test 3: Visitor Receives Admin Replies</h2>
                <div class="instructions">
                    <strong>What we're testing:</strong> When admin sends a
                    reply, visitor should see it in the widget within 2-4
                    seconds (polling interval).<br />
                    <strong>How to test:</strong>
                    <ol style="margin: 10px 0">
                        <li>Send a test message from the widget (Test 1)</li>
                        <li>
                            Go to Admin Dashboard and reply with a test message
                        </li>
                        <li>Return to this page (don't refresh widget)</li>
                        <li>
                            Wait 2-4 seconds - admin reply should appear
                            automatically
                        </li>
                        <li>
                            Click "Check Polling" to verify it's fetching
                            messages
                        </li>
                    </ol>
                </div>
                <div class="test-controls">
                    <button id="test-polling-btn">Check Polling Status</button>
                    <button class="secondary" id="manual-poll-btn">
                        Manual Poll Now
                    </button>
                </div>
                <div class="output" id="polling-output"></div>
            </div>

            <!-- Test 4: Database Verification -->
            <div class="test-section">
                <h2>Test 4: Database Verification</h2>
                <div class="instructions">
                    <strong>What we're testing:</strong> Verify that messages
                    are being stored in the database correctly.<br />
                </div>
                <div class="test-controls">
                    <button id="check-db-btn">Check Database Status</button>
                </div>
                <div class="output" id="db-output"></div>
            </div>

            <!-- Debug Panel -->
            <div class="test-section">
                <h2>Debug Information</h2>
                <div id="debug-info"></div>
            </div>
        </div>

        <!-- Load the chat widget -->
        <script>
            // Configure widget
            window.ChatbotWidgetConfig = {
                apiUrl: "http://127.0.0.1:8000/api/chat/send",
                apiKey: "123456",
                serverUrl: "http://127.0.0.1:8000",
                logoUrl: "http://127.0.0.1:8000/images/chatbot-logo.png",
            };

            // Load widget script
            const script = document.createElement("script");
            script.src = "http://127.0.0.1:8000/widget/chat-widget.js";
            script.onload = () => {
                console.log("Chat widget loaded");
                document.getElementById("server-status").innerHTML =
                    '<span style="color: #10b981;">âœ“ Server connected</span>';
            };
            script.onerror = () => {
                console.error("Failed to load chat widget");
                document.getElementById("server-status").innerHTML =
                    '<span style="color: #ef4444;">âœ— Failed to connect to server</span>';
            };
            document.head.appendChild(script);

            // Utility functions
            function log(elementId, message, type = "info") {
                const output = document.getElementById(elementId);
                const line = document.createElement("div");
                line.className = `output-line ${type}`;
                const timestamp = new Date().toLocaleTimeString();
                line.textContent = `[${timestamp}] ${message}`;
                output.appendChild(line);
                output.scrollTop = output.scrollHeight;
            }

            function clearOutput(elementId) {
                document.getElementById(elementId).innerHTML = "";
            }

            // Test 1: Message Persistence
            document
                .getElementById("open-widget-btn")
                .addEventListener("click", () => {
                    const launcher = document.querySelector(".cb-launcher");
                    if (launcher) {
                        launcher.click();
                        log("storage-output", "âœ“ Widget opened", "success");
                    } else {
                        log("storage-output", "âœ— Widget not found", "error");
                    }
                });

            document
                .getElementById("refresh-page-btn")
                .addEventListener("click", () => {
                    log("storage-output", "Refreshing page...", "info");
                    setTimeout(() => location.reload(), 500);
                });

            document
                .getElementById("check-storage-btn")
                .addEventListener("click", () => {
                    clearOutput("storage-output");
                    const visitorToken = localStorage.getItem("visitor_token");
                    log(
                        "storage-output",
                        `Visitor Token: ${visitorToken}`,
                        "info",
                    );

                    if (visitorToken) {
                        const convKey = `chatbot_conversation_${visitorToken}`;
                        const msgKey = `chatbot_messages_${visitorToken}`;

                        const convId = localStorage.getItem(convKey);
                        const messages = localStorage.getItem(msgKey);

                        log(
                            "storage-output",
                            `Conversation ID: ${convId}`,
                            "info",
                        );
                        log(
                            "storage-output",
                            `Messages in localStorage:`,
                            "info",
                        );

                        if (messages) {
                            try {
                                const msgArray = JSON.parse(messages);
                                log(
                                    "storage-output",
                                    `Total messages stored: ${msgArray.length}`,
                                    "success",
                                );
                                msgArray.forEach((msg, idx) => {
                                    log(
                                        "storage-output",
                                        `  ${idx + 1}. [${msg.sender_type}] ${msg.message.substring(0, 50)}...`,
                                        "info",
                                    );
                                });
                            } catch (e) {
                                log(
                                    "storage-output",
                                    `Error parsing messages: ${e.message}`,
                                    "error",
                                );
                            }
                        } else {
                            log(
                                "storage-output",
                                "No messages found in localStorage",
                                "warning",
                            );
                        }
                    } else {
                        log(
                            "storage-output",
                            "No visitor token found",
                            "error",
                        );
                    }
                });

            document
                .getElementById("clear-storage-btn")
                .addEventListener("click", () => {
                    if (confirm("Clear all chat data from localStorage?")) {
                        localStorage.removeItem("visitor_token");
                        const keys = Object.keys(localStorage);
                        keys.forEach((key) => {
                            if (key.startsWith("chatbot_")) {
                                localStorage.removeItem(key);
                            }
                        });
                        log(
                            "storage-output",
                            "âœ“ All chat data cleared",
                            "success",
                        );
                        setTimeout(() => location.reload(), 1000);
                    }
                });

            // Test 2: Admin Dashboard
            document
                .getElementById("open-admin-btn")
                .addEventListener("click", () => {
                    window.open(
                        "http://127.0.0.1:8000/admin/conversations",
                        "_blank",
                    );
                    log(
                        "admin-output",
                        "âœ“ Opened admin dashboard in new tab",
                        "success",
                    );
                });

            document
                .getElementById("fetch-conversations-btn")
                .addEventListener("click", async () => {
                    clearOutput("admin-output");
                    log("admin-output", "Fetching conversations...", "info");
                    try {
                        const response = await fetch(
                            "http://127.0.0.1:8000/api/chat/conversations",
                        );
                        if (!response.ok) {
                            log(
                                "admin-output",
                                `API returned ${response.status}`,
                                "error",
                            );
                            return;
                        }
                        const data = await response.json();
                        log(
                            "admin-output",
                            `Total conversations: ${data.length}`,
                            "success",
                        );
                        data.forEach((conv, idx) => {
                            log(
                                "admin-output",
                                `  ${idx + 1}. Conv #${conv.id}: ${conv.message_count || 0} messages`,
                                "info",
                            );
                        });
                    } catch (e) {
                        log("admin-output", `Error: ${e.message}`, "error");
                    }
                });

            // Test 3: Polling
            let pollCheckInterval = null;

            document
                .getElementById("test-polling-btn")
                .addEventListener("click", () => {
                    clearOutput("polling-output");
                    log(
                        "polling-output",
                        "Testing polling mechanism...",
                        "info",
                    );

                    const visitorToken = localStorage.getItem("visitor_token");
                    const convId = localStorage.getItem(
                        `chatbot_conversation_${visitorToken}`,
                    );

                    if (!visitorToken) {
                        log(
                            "polling-output",
                            "No visitor token found",
                            "error",
                        );
                        return;
                    }
                    if (!convId) {
                        log(
                            "polling-output",
                            "No conversation ID stored",
                            "warning",
                        );
                        return;
                    }

                    log(
                        "polling-output",
                        `Visitor Token: ${visitorToken}`,
                        "info",
                    );
                    log("polling-output", `Conversation ID: ${convId}`, "info");
                    log(
                        "polling-output",
                        "Starting 5-second polling test...",
                        "info",
                    );

                    let pollCount = 0;
                    const startTime = Date.now();

                    pollCheckInterval = setInterval(async () => {
                        pollCount++;
                        try {
                            const response = await fetch(
                                "http://127.0.0.1:8000/api/chat/messages",
                                {
                                    method: "POST",
                                    headers: {
                                        "Content-Type": "application/json",
                                    },
                                    body: JSON.stringify({
                                        api_key: "123456",
                                        visitor_token: visitorToken,
                                        conversation_id: convId,
                                        after_id: 0,
                                    }),
                                },
                            );
                            const data = await response.json();
                            log(
                                "polling-output",
                                `Poll #${pollCount}: Found ${data.messages?.length || 0} messages`,
                                "success",
                            );
                        } catch (e) {
                            log(
                                "polling-output",
                                `Poll #${pollCount}: Error - ${e.message}`,
                                "error",
                            );
                        }

                        if (pollCount >= 3) {
                            clearInterval(pollCheckInterval);
                            log(
                                "polling-output",
                                "Polling test complete",
                                "success",
                            );
                        }
                    }, 1500);
                });

            document
                .getElementById("manual-poll-btn")
                .addEventListener("click", async () => {
                    clearOutput("polling-output");
                    const visitorToken = localStorage.getItem("visitor_token");
                    const convId = localStorage.getItem(
                        `chatbot_conversation_${visitorToken}`,
                    );

                    if (!visitorToken || !convId) {
                        log(
                            "polling-output",
                            "Missing visitor token or conversation ID",
                            "error",
                        );
                        return;
                    }

                    log(
                        "polling-output",
                        "Fetching messages manually...",
                        "info",
                    );
                    try {
                        const response = await fetch(
                            "http://127.0.0.1:8000/api/chat/messages",
                            {
                                method: "POST",
                                headers: { "Content-Type": "application/json" },
                                body: JSON.stringify({
                                    api_key: "123456",
                                    visitor_token: visitorToken,
                                    conversation_id: convId,
                                    after_id: 0,
                                }),
                            },
                        );
                        const data = await response.json();
                        log(
                            "polling-output",
                            `Found ${data.messages?.length || 0} messages`,
                            "success",
                        );
                        if (data.messages && data.messages.length > 0) {
                            data.messages.forEach((msg, idx) => {
                                log(
                                    "polling-output",
                                    `  ${idx + 1}. [${msg.sender_type}] ${msg.message}`,
                                    "info",
                                );
                            });
                        }
                    } catch (e) {
                        log("polling-output", `Error: ${e.message}`, "error");
                    }
                });

            // Test 4: Database Check
            document
                .getElementById("check-db-btn")
                .addEventListener("click", async () => {
                    clearOutput("db-output");
                    log("db-output", "Checking database...", "info");
                    try {
                        const response = await fetch(
                            "http://127.0.0.1:8000/api/debug/database",
                        );
                        if (!response.ok) {
                            // Try alternative endpoint
                            log(
                                "db-output",
                                "Debug endpoint not available (expected for production)",
                                "warning",
                            );
                            log(
                                "db-output",
                                "Running PHP artisan command instead...",
                                "info",
                            );
                            return;
                        }
                        const data = await response.json();
                        log("db-output", JSON.stringify(data, null, 2), "info");
                    } catch (e) {
                        log(
                            "db-output",
                            "Could not reach debug endpoint. This is normal.",
                            "warning",
                        );
                        log(
                            "db-output",
                            'To check database: Run "php artisan debug:database"',
                            "info",
                        );
                    }
                });

            // Show debug info
            window.addEventListener("load", () => {
                const debugDiv = document.getElementById("debug-info");
                debugDiv.innerHTML = `
                <p><strong>Browser Storage:</strong></p>
                <p>LocalStorage visitor_token: ${localStorage.getItem("visitor_token") || "Not set"}</p>
                <p><strong>Widget Status:</strong></p>
                <p>Widget Script: ${window.ChatbotWidgetConfig ? "âœ“ Loaded" : "âœ— Not loaded"}</p>
            `;
            });
        </script>
    </body>
</html>
