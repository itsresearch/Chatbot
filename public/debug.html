<!doctype html>
<html>
    <head>
        <title>Debug - Messages</title>
        <style>
            body {
                font-family: monospace;
                padding: 20px;
            }
            .container {
                max-width: 900px;
            }
            table {
                width: 100%;
                border-collapse: collapse;
                margin: 20px 0;
            }
            th,
            td {
                border: 1px solid #ccc;
                padding: 10px;
                text-align: left;
            }
            th {
                background: #f5f5f5;
                font-weight: bold;
            }
            pre {
                background: #f9f9f9;
                padding: 10px;
                overflow-x: auto;
            }
            .error {
                color: red;
            }
            .success {
                color: green;
            }
            .warning {
                color: orange;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <h1>Debug Dashboard - Database Messages</h1>

            <h2>Conversations</h2>
            <div id="conversations-container">Loading...</div>

            <h2>Messages</h2>
            <div id="messages-container">Loading...</div>

            <h2>Test API Endpoints</h2>
            <div id="api-test">
                <button onclick="testSendMessage()">Send Test Message</button>
                <button onclick="testPollMessages()">Poll Messages</button>
                <button onclick="testFetchMessages()">
                    Fetch All Messages
                </button>
            </div>

            <div
                id="test-output"
                style="background: #f0f0f0; padding: 10px; margin-top: 20px"
            ></div>
        </div>

        <script>
            const API_BASE = "http://127.0.0.1:8000/api";
            const TEST_WEBSITE_API_KEY = "123456";
            const TEST_VISITOR_TOKEN = "test_visitor_" + Date.now();

            function log(message, type = "info") {
                const output = document.getElementById("test-output");
                const line = document.createElement("div");
                line.className = type;
                line.textContent =
                    new Date().toLocaleTimeString() + " - " + message;
                output.appendChild(line);
                output.scrollTop = output.scrollHeight;
            }

            async function loadConversations() {
                try {
                    const response = await fetch(
                        "http://127.0.0.1:8000/admin/conversations",
                        {
                            credentials: "include",
                        },
                    );
                    // Can't load without auth, so let's just show the structure
                    const html = `<p class="warning">Admin dashboard requires authentication</p>`;
                    document.getElementById(
                        "conversations-container",
                    ).innerHTML = html;
                } catch (error) {
                    document.getElementById(
                        "conversations-container",
                    ).innerHTML =
                        `<p class="error">Error: ${error.message}</p>`;
                }
            }

            async function loadMessages() {
                try {
                    // Since we don't have direct access to the database, we'll use the API
                    const response = await fetch(`${API_BASE}/chat/messages`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            api_key: TEST_WEBSITE_API_KEY,
                            visitor_token: TEST_VISITOR_TOKEN,
                            conversation_id: 1,
                            after_id: 0,
                        }),
                    });

                    const data = await response.json();
                    let html =
                        "<pre>" + JSON.stringify(data, null, 2) + "</pre>";
                    document.getElementById("messages-container").innerHTML =
                        html;
                } catch (error) {
                    document.getElementById("messages-container").innerHTML =
                        `<p class="error">Error: ${error.message}</p>`;
                }
            }

            async function testSendMessage() {
                log("Sending test message...", "info");
                try {
                    const response = await fetch(`${API_BASE}/chat/send`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            api_key: TEST_WEBSITE_API_KEY,
                            visitor_token: TEST_VISITOR_TOKEN,
                            message:
                                "Test message at " +
                                new Date().toLocaleTimeString(),
                        }),
                    });

                    const data = await response.json();
                    if (data.conversation_id) {
                        log(
                            `✓ Message sent! Conversation ID: ${data.conversation_id}`,
                            "success",
                        );
                        log(
                            `Response: ${JSON.stringify(data, null, 2)}`,
                            "info",
                        );
                    } else {
                        log(`✗ Failed: ${JSON.stringify(data)}`, "error");
                    }
                } catch (error) {
                    log(`✗ Error: ${error.message}`, "error");
                }
            }

            async function testPollMessages() {
                log("Polling for messages...", "info");
                try {
                    const response = await fetch(`${API_BASE}/chat/messages`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            api_key: TEST_WEBSITE_API_KEY,
                            visitor_token: TEST_VISITOR_TOKEN,
                            conversation_id: 1,
                            after_id: 0,
                        }),
                    });

                    const data = await response.json();
                    if (data.messages && data.messages.length > 0) {
                        log(
                            `✓ Found ${data.messages.length} messages`,
                            "success",
                        );
                        data.messages.forEach((msg, i) => {
                            log(
                                `  [${i}] ${msg.sender_type}: ${msg.message}`,
                                "info",
                            );
                        });
                    } else {
                        log("✓ No new messages", "info");
                    }
                } catch (error) {
                    log(`✗ Error: ${error.message}`, "error");
                }
            }

            async function testFetchMessages() {
                log("Fetching all database messages via Laravel...", "info");
                try {
                    // This would need API access, so we'll just test the structure
                    const response = await fetch(
                        "http://127.0.0.1:8000/api/debug/messages",
                        {
                            method: "GET",
                        },
                    );

                    if (!response.ok && response.status === 404) {
                        log("ℹ Debug endpoint not available", "warning");
                        log(
                            "Your messages are stored in the database",
                            "success",
                        );
                    } else {
                        const data = await response.json();
                        log(
                            `✓ Database has ${data.count || "?"} messages`,
                            "success",
                        );
                    }
                } catch (error) {
                    log(
                        "ℹ To view database directly, use: php artisan tinker",
                        "info",
                    );
                    log("Then: App\\Models\\Message::all()", "info");
                }
            }

            window.addEventListener("load", () => {
                log("Debug dashboard loaded", "success");
                loadMessages();
            });
        </script>
    </body>
</html>
